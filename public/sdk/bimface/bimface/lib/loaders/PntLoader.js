"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},CLOUD=CLOUD||{};!function(){function e(e,r,t){return r<=e&&e<=t}function r(e){if(void 0===e)return{};if(e===Object(e))return e;throw TypeError("Could not convert argument to dictionary")}function t(e){for(var r=String(e),t=r.length,n=0,o=[];n<t;){var i=r.charCodeAt(n);if(i<55296||i>57343)o.push(i);else if(56320<=i&&i<=57343)o.push(65533);else if(55296<=i&&i<=56319)if(n===t-1)o.push(65533);else{var a=e.charCodeAt(n+1);if(56320<=a&&a<=57343){var s=1023&i,l=1023&a;o.push(65536+(s<<10)+l),n+=1}else o.push(65533)}n+=1}return o}function n(e){for(var r="",t=0;t<e.length;++t){var n=e[t];n<=65535?r+=String.fromCharCode(n):(n-=65536,r+=String.fromCharCode(55296+(n>>10),56320+(1023&n)))}return r}function o(e){this.tokens=[].slice.call(e)}function i(e,r){if(e)throw TypeError("Decoder error");return r||65533}function a(e,t){if(!(this instanceof a))return new a(e,t);if((e=void 0!==e?String(e).toLowerCase():h)!==h)throw new Error("Encoding not supported. Only utf-8 is supported");t=r(t),this._streaming=!1,this._BOMseen=!1,this._decoder=null,this._fatal=Boolean(t.fatal),this._ignoreBOM=Boolean(t.ignoreBOM),Object.defineProperty(this,"encoding",{value:"utf-8"}),Object.defineProperty(this,"fatal",{value:this._fatal}),Object.defineProperty(this,"ignoreBOM",{value:this._ignoreBOM})}function s(e,t){if(!(this instanceof s))return new s(e,t);if((e=void 0!==e?String(e).toLowerCase():h)!==h)throw new Error("Encoding not supported. Only utf-8 is supported");t=r(t),this._streaming=!1,this._encoder=null,this._options={fatal:Boolean(t.fatal)},Object.defineProperty(this,"encoding",{value:"utf-8"})}function l(r){var t=r.fatal,n=0,o=0,a=0,s=128,l=191;this.handler=function(r,u){if(u===d&&0!==a)return a=0,i(t);if(u===d)return c;if(0===a){if(e(u,0,127))return u;if(e(u,194,223))a=1,n=u-192;else if(e(u,224,239))224===u&&(s=160),237===u&&(l=159),a=2,n=u-224;else{if(!e(u,240,244))return i(t);240===u&&(s=144),244===u&&(l=143),a=3,n=u-240}return n<<=6*a,null}if(!e(u,s,l))return n=a=o=0,s=128,l=191,r.prepend(u),i(t);if(s=128,l=191,o+=1,n+=u-128<<6*(a-o),o!==a)return null;var f=n;return n=a=o=0,f}}function u(r){r.fatal;this.handler=function(r,t){if(t===d)return c;if(e(t,0,127))return t;var n,o;e(t,128,2047)?(n=1,o=192):e(t,2048,65535)?(n=2,o=224):e(t,65536,1114111)&&(n=3,o=240);for(var i=[(t>>6*n)+o];n>0;){var a=t>>6*(n-1);i.push(128|63&a),n-=1}return i}}function f(){if("undefined"!=typeof self)return self;if("undefined"!=typeof global)return global;throw new Error("No global found")}var d=-1;o.prototype={endOfStream:function(){return!this.tokens.length},read:function(){return this.tokens.length?this.tokens.shift():d},prepend:function(e){if(Array.isArray(e))for(var r=e;r.length;)this.tokens.unshift(r.pop());else this.tokens.unshift(e)},push:function(e){if(Array.isArray(e))for(var r=e;r.length;)this.tokens.push(r.shift());else this.tokens.push(e)}};var c=-1,h="utf-8";a.prototype={decode:function(e,t){var i;i="object"===(void 0===e?"undefined":_typeof(e))&&e instanceof ArrayBuffer?new Uint8Array(e):"object"===(void 0===e?"undefined":_typeof(e))&&"buffer"in e&&e.buffer instanceof ArrayBuffer?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(0),t=r(t),this._streaming||(this._decoder=new l({fatal:this._fatal}),this._BOMseen=!1),this._streaming=Boolean(t.stream);for(var a,s=new o(i),u=[];!s.endOfStream()&&(a=this._decoder.handler(s,s.read()))!==c;)null!==a&&(Array.isArray(a)?u.push.apply(u,a):u.push(a));if(!this._streaming){do{if((a=this._decoder.handler(s,s.read()))===c)break;null!==a&&(Array.isArray(a)?u.push.apply(u,a):u.push(a))}while(!s.endOfStream());this._decoder=null}return u.length&&(-1===["utf-8"].indexOf(this.encoding)||this._ignoreBOM||this._BOMseen||(65279===u[0]?(this._BOMseen=!0,u.shift()):this._BOMseen=!0)),n(u)}},s.prototype={encode:function(e,n){e=e?String(e):"",n=r(n),this._streaming||(this._encoder=new u(this._options)),this._streaming=Boolean(n.stream);for(var i,a=[],s=new o(t(e));!s.endOfStream()&&(i=this._encoder.handler(s,s.read()))!==c;)Array.isArray(i)?a.push.apply(a,i):a.push(i);if(!this._streaming){for(;;){if((i=this._encoder.handler(s,s.read()))===c)break;Array.isArray(i)?a.push.apply(a,i):a.push(i)}this._encoder=null}return new Uint8Array(a)}},"function"!=typeof TextDecoder&&(f().TextDecoder=a),"function"!=typeof TextEncoder&&(f().TextEncoder=s)}();var PntsParser=function(){function e(){_classCallCheck(this,e),this.utf8Decoder=new TextDecoder("utf-8")}return _createClass(e,[{key:"parse",value:function(e){if(!e)return Promise.reject(e);var r=new DataView(e),t=0,n={},o={},i={};if(n.magic=this.utf8Decoder.decode(new Uint8Array(e,t,4)),t+=4,n.magic){if(n.version=r.getUint32(t,!0),t+=Uint32Array.BYTES_PER_ELEMENT,n.byteLength=r.getUint32(t,!0),t+=Uint32Array.BYTES_PER_ELEMENT,n.FTJSONLength=r.getUint32(t,!0),t+=Uint32Array.BYTES_PER_ELEMENT,n.FTBinaryLength=r.getUint32(t,!0),t+=Uint32Array.BYTES_PER_ELEMENT,n.BTJSONLength=r.getUint32(t,!0),t+=Uint32Array.BYTES_PER_ELEMENT,n.BTBinaryLength=r.getUint32(t,!0),t+=Uint32Array.BYTES_PER_ELEMENT,n.FTBinaryLength>0&&(i=this.parseFeatureBinary(e,t,n.FTJSONLength)),n.BTJSONLength>0){var a=28+n.FTJSONLength+n.FTBinaryLength;o=BatchTableParser.parse(e.slice(a,n.BTJSONLength+a))}var s={point:i,batchTable:o};return Promise.resolve(s)}throw new Error("Invalid pnts file.")}},{key:"parseFeatureBinary",value:function(e,r,t){var n=new THREE.BufferGeometry,o=this.utf8Decoder.decode(new Uint8Array(e,r,t)),i=JSON.parse(o),a=void 0;if(i.POINTS_LENGTH&&(a=i.POINTS_LENGTH),i.POSITION){var s=i.POSITION.byteOffset+o.length+r,l=new Float32Array(e,s,3*a);n.addAttribute("position",new THREE.BufferAttribute(l,3))}if(i.RGB){var u=i.RGB.byteOffset+o.length+r,f=new Uint8Array(e,u,3*a);n.addAttribute("color",new THREE.BufferAttribute(f,3,!0))}if(i.POSITION_QUANTIZED)throw new Error("For pnts loader, POSITION_QUANTIZED: not yet managed");if(i.RGBA)throw new Error("For pnts loader, RGBA: not yet managed");if(i.RGB565)throw new Error("For pnts loader, RGB565: not yet managed");if(i.NORMAL){var d=i.RGB.byteOffset+o.length+r,c=new Float32Array(e,d,3*a);n.addAttribute("normal",new THREE.BufferAttribute(c,3))}if(i.NORMAL_OCT16P)throw new Error("For pnts loader, NORMAL_OCT16P: not yet managed");if(i.BATCH_ID)throw new Error("For pnts loader, BATCH_ID: not yet managed");return{geometry:n,offset:i.RTC_CENTER?(new THREE.Vector3).fromArray(i.RTC_CENTER):void 0}}}]),e}();CLOUD.PntsParser=PntsParser;var ExtendTileset=function(){function e(r,t){_classCallCheck(this,e),this.tileset=r,this.baseURL=t,this.counter=1,this.index={},this.inverseTileTransform=new THREE.Matrix4,this.recurse(r.root,t)}return _createClass(e,[{key:"recurse",value:function(e,r,t){if(e.transform=e.transform?(new THREE.Matrix4).fromArray(e.transform):void 0,e._worldFromLocalTransform=e.transform,t&&t._worldFromLocalTransform&&(e.transform?e._worldFromLocalTransform=(new THREE.Matrix4).multiplyMatrices(t._worldFromLocalTransform,e.transform):e._worldFromLocalTransform=t._worldFromLocalTransform),(e.viewerRequestVolume&&e.viewerRequestVolume.region||e.boundingVolume.region)&&(e._worldFromLocalTransform?this.inverseTileTransform.getInverse(e._worldFromLocalTransform):this.inverseTileTransform.identity()),e.viewerRequestVolume=e.viewerRequestVolume?this.getBox(e.viewerRequestVolume,this.inverseTileTransform):void 0,e.boundingVolume=this.getBox(e.boundingVolume,this.inverseTileTransform),this.index[this.counter]=e,e.tileId=this.counter,e.baseURL=r,e.points=void 0,e.b3dm=void 0,this.counter++,e.children){var n=!0,o=!1,i=void 0;try{for(var a,s=e.children[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value;this.recurse(l,r,e)}}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}}}},{key:"getBox",value:function(e,r){if(e.region){var t=e.region;extent.set(THREE.Math.radToDeg(t[0]),THREE.Math.radToDeg(t[2]),THREE.Math.radToDeg(t[1]),THREE.Math.radToDeg(t[3]));var n=(new OBB).setFromExtent(extent);return n.matrix.premultiply(r),n.matrix.decompose(n.position,n.quaternion,n.scale),{region:n}}if(e.box){var o=e.box,i=new THREE.Vector3(o[0],o[1],o[2]),a=i.x-o[3],s=i.x+o[3],l=i.y-o[7],u=i.y+o[7],f=i.z-o[11],d=i.z+o[11];return{box:new THREE.Box3(new THREE.Vector3(a,l,f),new THREE.Vector3(s,u,d))}}if(e.sphere){return{sphere:new THREE.Sphere(new THREE.Vector3(e.sphere[0],e.sphere[1],e.sphere[2]),e.sphere[3])}}}}]),e}();CLOUD.ExtendTileset=ExtendTileset;var PntLoader=function(){function e(r,t){_classCallCheck(this,e),this.unitScale=t,this.pntParser=new PntsParser,this.utf8Decoder=new TextDecoder("utf-8"),this.tileIndexMap={},this.rootPntUrl=void 0,this.maximumScreenSpaceError=void 0===r?5:r,this.loadPromises=[],this.camera=void 0,this.globalInverseMatrix=new THREE.Matrix4,this.box=null,this.loadJsonPromises=[],this.pntFileList={}}return _createClass(e,[{key:"loadPntTotalJson",value:function(e,r){var t=this;return t.loadPromises=[],this.rootPntUrl=e.slice(0,e.lastIndexOf("/")+1),new Promise(function(n,o){(new THREE.FileLoader).load(e,function(e){var o=JSON.parse(e);t.box=o.root.boundingVolume.box,r&&r(t.box),t.parseTilesJson(o.root);var i=Promise.all(t.loadJsonPromises.map(function(e){return e.catch(function(e){return e})})),a=new CLOUD.TaskManager;i.then(function(e){var r=0;for(var o in t.tileIndexMap){var i=t.tileIndexMap[o],s=o.slice(0,o.lastIndexOf("/")+1);for(var l in i.index){var u=s+i.index[l].content.url;a.addTask(r),t.pntFileList[r]={},t.pntFileList[r].jsonUrl=o,t.pntFileList[r].pntUrl=u,t.pntFileList[r].index=l,r++}}a.processTasks(t.loadPnt.bind(t),void 0,function(e){var r={};for(var o in t.pntFileList){var i=t.pntFileList[o].jsonUrl;if(!(i in r)){var a=new CLOUD.ObjectGroup(CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0});r[i]=a}t.tileIndexMap[i].index[t.pntFileList[o].index].points=t.pntFileList[o].result,r[i].add(t.pntFileList[o].result)}var s=[];for(var i in r)s.push(r[i]);n(s)})})})})}},{key:"parseTilesJson",value:function(e){var r=this;if(e.content&&e.content.url){var t=this.rootPntUrl+e.content.url;r.loadTileSetJson(t)}if(e.children){var n=!0,o=!1,i=void 0;try{for(var a,s=e.children[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value;this.parseTilesJson(l)}}catch(e){o=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(o)throw i}}}}},{key:"loadTileSetJson",value:function(e){var r=this,t=new Promise(function(t,n){var o=new THREE.FileLoader;o.setResponseType("json"),o.load(e,function(o){if(null===o||void 0===o)n(o);else{var i=new ExtendTileset(o,"");r.tileIndexMap[e]=i;i.index[1],e.slice(0,e.lastIndexOf("/")+1);t(i)}},void 0,function(r){n(data),console.error("Load "+e+" failed, "+r)})});return r.loadJsonPromises.push(t),t}},{key:"ProcessTileIndexs",value:function(e,r){this.camera=e,this.globalInverseMatrix=r;for(var t in this.tileIndexMap){var n=this.tileIndexMap[t],o=n.index[1];this.ProcessNode(o,t)}}},{key:"ProcessNode",value:function(e,r,t){e.visible=!1;var n=this.tileIndexMap[r].index[e.tileId].points;if(void 0!=n){n.visible=!1;if(this.$3dTilesSubdivisionControl(this.camera,e)&&(n.visible=!0,e.visible=!0),void 0!=t)if("ADD"===t.refine.toUpperCase());else{t.visible=!1;var o=this.tileIndexMap[r].index[t.tileId];o.visible=!1}if(e.children){var i=!0,a=!1,s=void 0;try{for(var l,u=e.children[Symbol.iterator]();!(i=(l=u.next()).done);i=!0){var f=l.value;this.ProcessNode(f,r,e)}}catch(e){a=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(a)throw s}}}}}},{key:"$3dTilesSubdivisionControl",value:function(e,r){return this.computeNodeSSE(e,r)>this.maximumScreenSpaceError}},{key:"computeNodeSSE",value:function(e,r){var t=new THREE.Box3,n=new THREE.Sphere,o=e.position.clone();if(o.multiplyScalar(1/this.unitScale),o.applyMatrix4(this.globalInverseMatrix),r.distance=0,r.boundingVolume.region)t.copy(r.boundingVolume.region.box3D),t.applyMatrix4(r.boundingVolume.region.matrixWorld),r.distance=t.distanceToPoint(o);else if(r.boundingVolume.box)t.copy(r.boundingVolume.box),r.matrixWorld&&t.applyMatrix4(r.matrixWorld),r.distance=t.distanceToPoint(o);else{if(!r.boundingVolume.sphere)return 1/0;n.copy(r.boundingVolume.sphere),n.applyMatrix4(r.matrixWorld),r.distance=Math.max(0,n.distanceToPoint(o))}return 0===r.distance?1/0:(r.geometricError-0<1e-4&&(r.geometricError=1),e._preSSE*(r.geometricError/r.distance))}},{key:"updatePreSse",value:function(e,r){var t=e.fov,n=THREE.Math.degToRad(t),o=r/(2*Math.tan(.5*n));e._preSSE=o}},{key:"loadPnt",value:function(e,r){var t=this,n=t.pntFileList[e].pntUrl;return new Promise(function(o,i){var a=new THREE.FileLoader;a.setResponseType("arraybuffer"),a.load(n,function(o){if(void 0!==o){var i=t.utf8Decoder.decode(new Uint8Array(o,0,4));if("{"===i[0]){o=JSON.parse(t.utf8Decoder.decode(new Uint8Array(o)));n.slice(0,n.lastIndexOf("/")+1)}else if("b3dm"==i)console.log("b3dm is load");else{if("pnts"!=i)return Promise.reject("Unsupported magic code "+i);console.log("pnts is load")}t.pntParser.parse(o).then(function(o){var i=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),a=new THREE.Points(o.point.geometry,i);o.point.offset&&a.position.copy(o.point.offset),a.visible=!1,a.name=n,t.pntFileList[e].result=a,r()})}},void 0,function(e){i(void 0)})})}},{key:"loadPntByPromise",value:function(e){var r=this;return new Promise(function(t,n){var o=new THREE.FileLoader;o.setResponseType("arraybuffer"),o.load(e,function(n){if(void 0!==n){var o=r.utf8Decoder.decode(new Uint8Array(n,0,4));if("{"===o[0]){n=JSON.parse(r.utf8Decoder.decode(new Uint8Array(n)));e.slice(0,e.lastIndexOf("/")+1)}else if("b3dm"==o)console.log("b3dm is load");else{if("pnts"!=o)return Promise.reject("Unsupported magic code "+o);console.log("pnts is load")}r.pntParser.parse(n).then(function(r){var n=new THREE.PointsMaterial({size:.05,vertexColors:THREE.VertexColors}),o=new THREE.Points(r.point.geometry,n);r.point.offset&&o.position.copy(r.point.offset),o.visible=!1,o.name=e,t(o)})}},void 0,function(e){n(void 0)})})}},{key:"loadPntTotalJsonByPromise",value:function(e,r){var t=this;return t.loadPromises=[],this.rootPntUrl=e.slice(0,e.lastIndexOf("/")+1),new Promise(function(n,o){(new THREE.FileLoader).load(e,function(e){var o=JSON.parse(e);t.box=o.root.boundingVolume.box,r&&r(t.box),t.parseTilesJson(o.root),Promise.all(t.loadJsonPromises.map(function(e){return e.catch(function(e){return e})})).then(function(e){var r=[];for(var o in t.tileIndexMap)!function(e){t.urlPointGroupMap[e]={};var n=t.tileIndexMap[e],o=e.slice(0,e.lastIndexOf("/")+1);for(var i in n.index)!function(i){var a=o+n.index[i].content.url;r.push(t.loadPnt(a).then(function(r){return{url:e,context:{index:i,result:r}}}))}(i)}(o);Promise.all(r.map(function(e){return e.catch(function(e){return e})})).then(function(e){for(var r in t.urlPointGroupMap){var o=new CLOUD.ObjectGroup(CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0});t.urlPointGroupMap[r]=o}var i=!0,a=!1,s=void 0;try{for(var l,u=e[Symbol.iterator]();!(i=(l=u.next()).done);i=!0){var f=l.value;void 0!==f&&(t.tileIndexMap[f.url].index[f.context.index].points=f.context.result,t.urlPointGroupMap[f.url].add(f.context.result))}}catch(e){a=!0,s=e}finally{try{!i&&u.return&&u.return()}finally{if(a)throw s}}var d=[];for(var c in t.urlPointGroupMap)d.push(t.urlPointGroupMap[c]);n(d)})}).catch(function(e){console.log("promise reject failed reason",e)})})})}}]),e}();CLOUD.PntLoader=PntLoader;