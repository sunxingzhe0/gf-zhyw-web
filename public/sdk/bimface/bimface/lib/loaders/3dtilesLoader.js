"use strict";THREE.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function r(){var e={};return{get:function(r){return e[r]},add:function(r,t){e[r]=t},remove:function(r){delete e[r]},removeAll:function(){e={}},update:function(r,t){for(var a in e){var n=e[a];n.update&&n.update(r,t)}}}}function t(e,r){var t={},a=e.material.uniforms;for(var n in a){var i=a[n];if(i.semantic){var s=i.node,o=e;s&&(o=r[s]),t[n]={semantic:i.semantic,sourceNode:o,targetNode:e,uniform:i}}}this.boundUniforms=t,this._m4=new THREE.Matrix4}function a(e){this.name=l.KHR_MATERIALS_COMMON,this.lights={};var r=e.extensions&&e.extensions[l.KHR_MATERIALS_COMMON]||{},t=r.lights||{};for(var a in t){var n,i=t[a],s=i[i.type],o=(new THREE.Color).fromArray(s.color);switch(i.type){case"directional":n=new THREE.DirectionalLight(o),n.position.set(0,0,1);break;case"point":n=new THREE.PointLight(o);break;case"spot":n=new THREE.SpotLight(o),n.position.set(0,0,1);break;case"ambient":n=new THREE.AmbientLight(o)}n&&(this.lights[a]=n)}}function n(e){this.name=l.KHR_BINARY_GLTF;var r=new DataView(e,0,f),t={magic:o(new Uint8Array(e.slice(0,4))),version:r.getUint32(4,!0),length:r.getUint32(8,!0),contentLength:r.getUint32(12,!0),contentFormat:r.getUint32(16,!0)};for(var a in p){var n=p[a];if(t[a]!==n)throw new Error('Unsupported glTF-Binary header: Expected "%s" to be "%s".',a,n)}var i=new Uint8Array(e,f,t.contentLength);this.header=t,this.content=o(i),this.body=e.slice(f+t.contentLength,t.length)}function i(e,r,t){if(!e)return Promise.resolve();var a,n=[];if("[object Array]"===Object.prototype.toString.call(e)){a=[];for(var i=e.length,s=0;s<i;s++){var o=r.call(t||this,e[s],s);o&&(n.push(o),o instanceof Promise?o.then(function(e,r){a[e]=r}.bind(this,s)):a[s]=o)}}else{a={};for(var c in e)if(e.hasOwnProperty(c)){var o=r.call(t||this,e[c],c);o&&(n.push(o),o instanceof Promise?o.then(function(e,r){a[e]=r}.bind(this,c)):a[c]=o)}}return Promise.all(n).then(function(){return a})}function s(e,r){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:(r||"")+e}function o(e){for(var r="",t=0;t<e.length;t++)r+=String.fromCharCode(e[t]);return r}function c(e,r){var t={};for(var a in r.attributes){var n=r.attributes[a],i=r.parameters[n],s=i.type,o=i.semantic;t[a]={type:s,semantic:o}}var c=r.parameters,u=r.attributes,E={};for(var a in t){var n=u[a],d=c[n],o=d.semantic;o&&(E[a]=d)}for(var n in E){var i=E[n],o=i.semantic,l=new RegExp("\\b"+n+"\\b","g");switch(o){case"POSITION":e=e.replace(l,"position");break;case"NORMAL":e=e.replace(l,"normal");break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":e=e.replace(l,"uv");break;case"TEXCOORD_1":e=e.replace(l,"uv2");break;case"COLOR_0":case"COLOR0":case"COLOR":e=e.replace(l,"color");break;case"WEIGHT":e=e.replace(l,"skinWeight");break;case"JOINT":e=e.replace(l,"skinIndex")}}return e}function u(){return new THREE.MeshPhongMaterial({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:THREE.FrontSide})}function E(e){this.isDeferredShaderMaterial=!0,this.params=e}function d(e,t,a){this.json=e||{},this.extensions=t||{},this.options=a||{},this.cache=new r}e.prototype={constructor:e,load:function(e,r,t,a){var n=this,i=this.path&&"string"==typeof this.path?this.path:THREE.Loader.prototype.extractUrlBase(e),s=new THREE.FileLoader(n.manager);s.setResponseType("arraybuffer"),s.load(e,function(e){n.parse(e,r,i)},t,a)},setCrossOrigin:function(e){this.crossOrigin=e},setPath:function(e){this.path=e},parse:function(e,r,t){var i,s={};o(new Uint8Array(e,0,4))===p.magic?(s[l.KHR_BINARY_GLTF]=new n(e),i=s[l.KHR_BINARY_GLTF].content):i=o(new Uint8Array(e));var c=JSON.parse(i);c.extensionsUsed&&c.extensionsUsed.indexOf(l.KHR_MATERIALS_COMMON)>=0&&(s[l.KHR_MATERIALS_COMMON]=new a(c)),new d(c,s,{path:t||this.path,crossOrigin:this.crossOrigin}).parse(function(e,t,a,n){r({scene:e,scenes:t,cameras:a,animations:n})})}},e.Shaders={update:function(){console.warn("THREE.GLTFLoader.Shaders has been deprecated, and now updates automatically.")}},t.prototype.update=function(e,r){var t=this.boundUniforms;for(var a in t){var n=t[a];switch(n.semantic){case"MODELVIEW":var i=n.uniform.value;i.multiplyMatrices(r.matrixWorldInverse,n.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var s=n.uniform.value;this._m4.multiplyMatrices(r.matrixWorldInverse,n.sourceNode.matrixWorld),s.getNormalMatrix(this._m4);break;case"PROJECTION":var i=n.uniform.value;i.copy(r.projectionMatrix);break;case"JOINTMATRIX":for(var o=n.uniform.value,c=0;c<o.length;c++)o[c].getInverse(n.sourceNode.matrixWorld).multiply(n.targetNode.skeleton.bones[c].matrixWorld).multiply(n.targetNode.skeleton.boneInverses[c]).multiply(n.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+n.semantic)}}},e.Animations={update:function(){console.warn("THREE.GLTFLoader.Animation has been deprecated. Use THREE.AnimationMixer instead.")}};var l={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common"},p={magic:"glTF",version:1,contentFormat:0},f=20;n.prototype.loadShader=function(e,r){var t=r[e.extensions[l.KHR_BINARY_GLTF].bufferView];return o(new Uint8Array(t))},n.prototype.loadTextureSourceUri=function(e,r){var t=e.extensions[l.KHR_BINARY_GLTF],a=r[t.bufferView],n=o(new Uint8Array(a));return"data:"+t.mimeType+";base64,"+btoa(n)};var h={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},m={5126:Number,35675:THREE.Matrix3,35676:THREE.Matrix4,35664:THREE.Vector2,35665:THREE.Vector3,35666:THREE.Vector4,35678:THREE.Texture},v={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},T={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},R={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},H={6406:THREE.AlphaFormat,6407:THREE.RGBFormat,6408:THREE.RGBAFormat,6409:THREE.LuminanceFormat,6410:THREE.LuminanceAlphaFormat},A={5121:THREE.UnsignedByteType,32819:THREE.UnsignedShort4444Type,32820:THREE.UnsignedShort5551Type,33635:THREE.UnsignedShort565Type},b={1028:THREE.BackSide,1029:THREE.FrontSide},w={512:THREE.NeverDepth,513:THREE.LessDepth,514:THREE.EqualDepth,515:THREE.LessEqualDepth,516:THREE.GreaterEqualDepth,517:THREE.NotEqualDepth,518:THREE.GreaterEqualDepth,519:THREE.AlwaysDepth},y={32774:THREE.AddEquation,32778:THREE.SubtractEquation,32779:THREE.ReverseSubtractEquation},O={0:THREE.ZeroFactor,1:THREE.OneFactor,768:THREE.SrcColorFactor,769:THREE.OneMinusSrcColorFactor,770:THREE.SrcAlphaFactor,771:THREE.OneMinusSrcAlphaFactor,772:THREE.DstAlphaFactor,773:THREE.OneMinusDstAlphaFactor,774:THREE.DstColorFactor,775:THREE.OneMinusDstColorFactor,776:THREE.SrcAlphaSaturateFactor},L={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},M={scale:"scale",translation:"position",rotation:"quaternion"},g={LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete},S={2884:"CULL_FACE",2929:"DEPTH_TEST",3042:"BLEND",3089:"SCISSOR_TEST",32823:"POLYGON_OFFSET_FILL",32926:"SAMPLE_ALPHA_TO_COVERAGE"};return E.prototype.create=function(){var e=THREE.UniformsUtils.clone(this.params.uniforms);for(var r in this.params.uniforms){var t=this.params.uniforms[r];t.value instanceof THREE.Texture&&(e[r].value=t.value,e[r].value.needsUpdate=!0),e[r].semantic=t.semantic,e[r].node=t.node}return this.params.uniforms=e,new THREE.RawShaderMaterial(this.params)},d.prototype._withDependencies=function(e){for(var r={},t=0;t<e.length;t++){var a=e[t],n="load"+a.charAt(0).toUpperCase()+a.slice(1),s=this.cache.get(a);if(void 0!==s)r[a]=s;else if(this[n]){var o=this[n]();this.cache.add(a,o),r[a]=o}}return i(r,function(e){return e})},d.prototype.parse=function(e){var r=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then(function(t){var a=[];for(var n in t.scenes)a.push(t.scenes[n]);var i=void 0!==r.scene?t.scenes[r.scene]:a[0],s=[];for(var n in t.cameras){var o=t.cameras[n];s.push(o)}var c=[];for(var n in t.animations)c.push(t.animations[n]);e(i,a,s,c)})},d.prototype.loadShaders=function(){var e=this.json,r=this.extensions,t=this.options;return this._withDependencies(["bufferViews"]).then(function(a){return i(e.shaders,function(e){return e.extensions&&e.extensions[l.KHR_BINARY_GLTF]?r[l.KHR_BINARY_GLTF].loadShader(e,a.bufferViews):new Promise(function(r){var a=new THREE.FileLoader;a.setResponseType("text"),a.load(s(e.uri,t.path),function(e){r(e)})})})})},d.prototype.loadBuffers=function(){var e=this.json,r=this.extensions,t=this.options;return i(e.buffers,function(e,a){return"binary_glTF"===a?r[l.KHR_BINARY_GLTF].body:"arraybuffer"===e.type||void 0===e.type?new Promise(function(r){var a=new THREE.FileLoader;a.setResponseType("arraybuffer"),a.load(s(e.uri,t.path),function(e){r(e)})}):void console.warn("THREE.GLTFLoader: "+e.type+" buffer type is not supported")})},d.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then(function(r){return i(e.bufferViews,function(e){var t=r.buffers[e.buffer],a=void 0!==e.byteLength?e.byteLength:0;return t.slice(e.byteOffset,e.byteOffset+a)})})},d.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then(function(r){return i(e.accessors,function(e){var t=r.bufferViews[e.bufferView],a=L[e.type],n=v[e.componentType],i=n.BYTES_PER_ELEMENT,s=i*a;if(e.byteStride&&e.byteStride!==s){var o=new n(t),c=new THREE.InterleavedBuffer(o,e.byteStride/i);return new THREE.InterleavedBufferAttribute(c,a,e.byteOffset/i)}return o=new n(t,e.byteOffset,e.count*a),new THREE.BufferAttribute(o,a)})})},d.prototype.loadTextures=function(){var e=this.json,r=this.extensions,t=this.options;return this._withDependencies(["bufferViews"]).then(function(a){return i(e.textures,function(n){if(n.source)return new Promise(function(i){var o=e.images[n.source],c=o.uri;o.extensions&&o.extensions[l.KHR_BINARY_GLTF]&&(c=r[l.KHR_BINARY_GLTF].loadTextureSourceUri(o,a.bufferViews));var u=THREE.Loader.Handlers.get(c);null===u&&(u=new THREE.TextureLoader),u.setCrossOrigin(t.crossOrigin),u.load(s(c,t.path),function(r){if(r.flipY=!1,void 0!==n.name&&(r.name=n.name),r.format=void 0!==n.format?H[n.format]:THREE.RGBAFormat,void 0!==n.internalFormat&&r.format!==H[n.internalFormat]&&console.warn("THREE.GLTFLoader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),r.type=void 0!==n.type?A[n.type]:THREE.UnsignedByteType,n.sampler){var t=e.samplers[n.sampler];r.magFilter=T[t.magFilter]||THREE.LinearFilter,r.minFilter=T[t.minFilter]||THREE.NearestMipMapLinearFilter,r.wrapS=R[t.wrapS]||THREE.RepeatWrapping,r.wrapT=R[t.wrapT]||THREE.RepeatWrapping}i(r)},void 0,function(){i()})})})})},d.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then(function(r){return i(e.materials,function(t){var a,n,i={},s={};if(t.extensions&&t.extensions[l.KHR_MATERIALS_COMMON]&&(n=t.extensions[l.KHR_MATERIALS_COMMON]),n){var o=["ambient","emission","transparent","transparency","doubleSided"];switch(n.technique){case"BLINN":case"PHONG":a=THREE.MeshPhongMaterial,o.push("diffuse","specular","shininess");break;case"LAMBERT":a=THREE.MeshLambertMaterial,o.push("diffuse");break;case"CONSTANT":default:a=THREE.MeshBasicMaterial}o.forEach(function(e){void 0!==n.values[e]&&(i[e]=n.values[e])}),(n.doubleSided||i.doubleSided)&&(s.side=THREE.DoubleSide),(n.transparent||i.transparent)&&(s.transparent=!0,s.opacity=void 0!==i.transparency?i.transparency:1)}else if(void 0===t.technique)a=THREE.MeshPhongMaterial,Object.assign(i,t.values);else{a=E;var u=e.techniques[t.technique];s.uniforms={};var d=e.programs[u.program];if(d){s.fragmentShader=r.shaders[d.fragmentShader],s.fragmentShader||(console.warn("ERROR: Missing fragment shader definition:",d.fragmentShader),a=THREE.MeshPhongMaterial);var p=r.shaders[d.vertexShader];p||(console.warn("ERROR: Missing vertex shader definition:",d.vertexShader),a=THREE.MeshPhongMaterial),s.vertexShader=c(p,u);var f=u.uniforms;for(var v in f){var T=f[v],R=u.parameters[T],H=R.type;if(!m[H])throw new Error("Unknown shader uniform param type: "+H);var A,L=R.count;void 0!==t.values&&(A=t.values[T]);var M=new m[H],g=R.semantic,_=R.node;switch(H){case h.FLOAT:M=R.value,"transparency"==T&&(s.transparent=!0),void 0!==A&&(M=A);break;case h.FLOAT_VEC2:case h.FLOAT_VEC3:case h.FLOAT_VEC4:case h.FLOAT_MAT3:R&&R.value&&M.fromArray(R.value),A&&M.fromArray(A);break;case h.FLOAT_MAT2:console.warn("FLOAT_MAT2 is not a supported uniform type");break;case h.FLOAT_MAT4:if(L){M=new Array(L);for(var x=0;x<L;x++)M[x]=new m[H];if(R&&R.value){var F=R.value;M.fromArray(F)}A&&M.fromArray(A)}else{if(R&&R.value){var N=R.value;M.fromArray(N)}A&&M.fromArray(A)}break;case h.SAMPLER_2D:M=void 0!==A?r.textures[A]:void 0!==R.value?r.textures[R.value]:null}s.uniforms[v]={value:M,semantic:g,node:_}}for(var C=u.states||{},D=C.enable||[],I=C.functions||{},k=!1,B=!1,U=!1,G=0,P=D.length;G<P;G++){var V=D[G];switch(S[V]){case"CULL_FACE":k=!0;break;case"DEPTH_TEST":B=!0;break;case"BLEND":U=!0;break;case"SCISSOR_TEST":case"POLYGON_OFFSET_FILL":case"SAMPLE_ALPHA_TO_COVERAGE":break;default:throw new Error("Unknown technique.states.enable: "+V)}}s.side=k?void 0!==I.cullFace?b[I.cullFace]:THREE.FrontSide:THREE.DoubleSide,s.depthTest=B,s.depthFunc=void 0!==I.depthFunc?w[I.depthFunc]:THREE.LessDepth,s.depthWrite=void 0===I.depthMask||I.depthMask[0],s.blending=U?THREE.CustomBlending:THREE.NoBlending,s.transparent=U;var j=I.blendEquationSeparate;void 0!==j?(s.blendEquation=y[j[0]],s.blendEquationAlpha=y[j[1]]):(s.blendEquation=THREE.AddEquation,s.blendEquationAlpha=THREE.AddEquation);var K=I.blendFuncSeparate;void 0!==K?(s.blendSrc=O[K[0]],s.blendDst=O[K[1]],s.blendSrcAlpha=O[K[2]],s.blendDstAlpha=O[K[3]]):(s.blendSrc=THREE.OneFactor,s.blendDst=THREE.ZeroFactor,s.blendSrcAlpha=THREE.OneFactor,s.blendDstAlpha=THREE.ZeroFactor)}}Array.isArray(i.diffuse)?s.color=(new THREE.Color).fromArray(i.diffuse):"string"==typeof i.diffuse&&(s.map=r.textures[i.diffuse]),delete s.diffuse,"string"==typeof i.reflective&&(s.envMap=r.textures[i.reflective]),"string"==typeof i.bump&&(s.bumpMap=r.textures[i.bump]),Array.isArray(i.emission)?a===THREE.MeshBasicMaterial?s.color=(new THREE.Color).fromArray(i.emission):s.emissive=(new THREE.Color).fromArray(i.emission):"string"==typeof i.emission&&(a===THREE.MeshBasicMaterial?s.map=r.textures[i.emission]:s.emissiveMap=r.textures[i.emission]),Array.isArray(i.specular)?s.specular=(new THREE.Color).fromArray(i.specular):"string"==typeof i.specular&&(s.specularMap=r.textures[i.specular]),void 0!==i.shininess&&(s.shininess=i.shininess);var q=new a(s);return void 0!==t.name&&(q.name=t.name),q})})},d.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then(function(r){return i(e.meshes,function(e){var t=new THREE.Group;void 0!==e.name&&(t.name=e.name),e.extras&&(t.userData=e.extras);var a=e.primitives||[];for(var n in a){var i=a[n];if(i.mode===h.TRIANGLES||void 0===i.mode){var s=new THREE.BufferGeometry,o=i.attributes;for(var c in o){var E=o[c];if(!E)return;var d=r.accessors[E];switch(c){case"POSITION":s.addAttribute("position",d);break;case"NORMAL":s.addAttribute("normal",d);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":s.addAttribute("uv",d);break;case"TEXCOORD_1":s.addAttribute("uv2",d);break;case"COLOR_0":case"COLOR0":case"COLOR":s.addAttribute("color",d);break;case"WEIGHT":s.addAttribute("skinWeight",d);break;case"JOINT":s.addAttribute("skinIndex",d)}}i.indices&&s.setIndex(r.accessors[i.indices]);var l=void 0!==r.materials?r.materials[i.material]:u(),p=new THREE.Mesh(s,l);p.castShadow=!0,p.name="0"===n?t.name:t.name+n,i.extras&&(p.userData=i.extras),t.add(p)}else if(i.mode===h.LINES){var s=new THREE.BufferGeometry,o=i.attributes;for(var c in o){var E=o[c];if(!E)return;var d=r.accessors[E];switch(c){case"POSITION":s.addAttribute("position",d);break;case"COLOR_0":case"COLOR0":case"COLOR":s.addAttribute("color",d)}}var p,l=r.materials[i.material];i.indices?(s.setIndex(r.accessors[i.indices]),p=new THREE.LineSegments(s,l)):p=new THREE.Line(s,l),p.name="0"===n?t.name:t.name+n,i.extras&&(p.userData=i.extras),t.add(p)}else console.warn("Only triangular and line primitives are supported")}return t})})},d.prototype.loadCameras=function(){return i(this.json.cameras,function(e){if("perspective"==e.type&&e.perspective){var r=e.perspective.yfov,t=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,a=r*t,n=new THREE.PerspectiveCamera(THREE.Math.radToDeg(a),t,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(n.name=e.name),e.extras&&(n.userData=e.extras),n}if("orthographic"==e.type&&e.orthographic){var n=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar);return void 0!==e.name&&(n.name=e.name),e.extras&&(n.userData=e.extras),n}})},d.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then(function(r){return i(e.skins,function(e){var t=new THREE.Matrix4;return void 0!==e.bindShapeMatrix&&t.fromArray(e.bindShapeMatrix),{bindShapeMatrix:t,jointNames:e.jointNames,inverseBindMatrices:r.accessors[e.inverseBindMatrices]}})})},d.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then(function(r){return i(e.animations,function(e,t){var a=[];for(var n in e.channels){var i=e.channels[n],s=e.samplers[i.sampler];if(s){var o=i.target,c=o.id,u=void 0!==e.parameters?e.parameters[s.input]:s.input,E=void 0!==e.parameters?e.parameters[s.output]:s.output,d=r.accessors[u],l=r.accessors[E],p=r.nodes[c];if(p){p.updateMatrix(),p.matrixAutoUpdate=!0;var f=M[o.path]===M.rotation?THREE.QuaternionKeyframeTrack:THREE.VectorKeyframeTrack,h=p.name?p.name:p.uuid,m=void 0!==s.interpolation?g[s.interpolation]:THREE.InterpolateLinear;a.push(new f(h+"."+M[o.path],THREE.AnimationUtils.arraySlice(d.array,0),THREE.AnimationUtils.arraySlice(l.array,0),m))}}}var c=void 0!==e.name?e.name:"animation_"+t;return new THREE.AnimationClip(c,void 0,a)})})},d.prototype.loadNodes=function(){var e=this.json,r=this.extensions,t=this;return i(e.nodes,function(e){var r,t=new THREE.Matrix4;return e.jointName?(r=new THREE.Bone,r.name=void 0!==e.name?e.name:e.jointName,r.jointName=e.jointName):(r=new THREE.Object3D,void 0!==e.name&&(r.name=e.name)),e.extras&&(r.userData=e.extras),void 0!==e.matrix?(t.fromArray(e.matrix),r.applyMatrix(t)):(void 0!==e.translation&&r.position.fromArray(e.translation),void 0!==e.rotation&&r.quaternion.fromArray(e.rotation),void 0!==e.scale&&r.scale.fromArray(e.scale)),r}).then(function(a){return t._withDependencies(["meshes","skins","cameras"]).then(function(t){return i(a,function(n,i){var s=e.nodes[i];if(void 0!==s.meshes)for(var o in s.meshes){var c=s.meshes[o],u=t.meshes[c];if(void 0!==u)for(var E in u.children){var d,p=u.children[E],f=p.material,h=p.geometry,m=p.userData,v=p.name;switch(f.isDeferredShaderMaterial?f=d=f.create():d=f,p.type){case"LineSegments":p=new THREE.LineSegments(h,d);break;case"LineLoop":p=new THREE.LineLoop(h,d);break;case"Line":p=new THREE.Line(h,d);break;default:p=new THREE.Mesh(h,d)}p.castShadow=!0,p.userData=m,p.name=v;var T;if(s.skin&&(T=t.skins[s.skin]),T){var R=h,d=f;d.skinning=!0,p=new THREE.SkinnedMesh(R,d,!1),p.castShadow=!0,p.userData=m,p.name=v;for(var H=[],A=[],b=0,w=T.jointNames.length;b<w;b++){var y=T.jointNames[b],O=function(e){for(var r=Object.keys(a),t=0,n=r.length;t<n;t++){var i=a[r[t]];if(i.jointName===e)return i}return null}(y);if(O){H.push(O);var L=T.inverseBindMatrices.array,M=(new THREE.Matrix4).fromArray(L,16*b);A.push(M)}else console.warn("WARNING: joint: '"+y+"' could not be found")}p.bind(new THREE.Skeleton(H,A,!1),T.bindShapeMatrix);!function r(t,n,i){var s=t[i];if(void 0!==s)for(var o=0,c=s.length;o<c;o++){var u=s[o],E=a[u],d=e.nodes[u];void 0!==E&&!0===E.isBone&&void 0!==d&&(n.add(E),r(d,E,"children"))}}(s,p,"skeletons")}n.add(p)}else console.warn("GLTFLoader: Couldn't find node \""+c+'".')}if(void 0!==s.camera){var g=t.cameras[s.camera];n.add(g)}if(s.extensions&&s.extensions[l.KHR_MATERIALS_COMMON]&&s.extensions[l.KHR_MATERIALS_COMMON].light){var S=r[l.KHR_MATERIALS_COMMON].lights,_=S[s.extensions[l.KHR_MATERIALS_COMMON].light];n.add(_)}return n})})})},d.prototype.loadScenes=function(){function e(t,a,n){var i=n[t];a.add(i);var s=r.nodes[t];if(s.children)for(var o=s.children,c=0,u=o.length;c<u;c++){var E=o[c];e(E,i,n)}}var r=this.json;return this._withDependencies(["nodes"]).then(function(a){return i(r.scenes,function(r){var n=new THREE.Scene;void 0!==r.name&&(n.name=r.name),r.extras&&(n.userData=r.extras);for(var i=r.nodes||[],s=0,o=i.length;s<o;s++){e(i[s],n,a.nodes)}return n.traverse(function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new t(e,a.nodes),e.onBeforeRender=function(e,r,t){this.gltfShader.update(r,t)})}),n})})},e}(),THREE.GLTF2Loader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function r(){var e={};return{get:function(r){return e[r]},add:function(r,t){e[r]=t},remove:function(r){delete e[r]},removeAll:function(){e={}},update:function(r,t){for(var a in e){var n=e[a];n.update&&n.update(r,t)}}}}function t(e,r){var t={},a=e.material.uniforms;for(var n in a){var i=a[n];if(i.semantic){var s=i.node,o=e;s&&(o=r[s]),t[n]={semantic:i.semantic,sourceNode:o,targetNode:e,uniform:i}}}this.boundUniforms=t,this._m4=new THREE.Matrix4}function a(e){this.name=l.KHR_MATERIALS_COMMON,this.lights={};var r=e.extensions&&e.extensions[l.KHR_MATERIALS_COMMON]||{},t=r.lights||{};for(var a in t){var n,i=t[a],s=i[i.type],o=(new THREE.Color).fromArray(s.color);switch(i.type){case"directional":n=new THREE.DirectionalLight(o),n.position.set(0,0,1);break;case"point":n=new THREE.PointLight(o);break;case"spot":n=new THREE.SpotLight(o),n.position.set(0,0,1);break;case"ambient":n=new THREE.AmbientLight(o)}n&&(this.lights[a]=n)}}function n(e){this.name=l.KHR_BINARY_GLTF,this.content=null,this.body=null;var r=new DataView(e,0,f);if(this.header={magic:o(new Uint8Array(e.slice(0,4))),version:r.getUint32(4,!0),length:r.getUint32(8,!0)},this.header.magic!==p)throw new Error("GLTF2Loader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("GLTF2Loader: Legacy binary file detected. Use GLTFLoader instead.");for(var t=new DataView(e,f),a=0;a<t.byteLength;){var n=t.getUint32(a,!0);a+=4;var i=t.getUint32(a,!0);if(a+=4,i===h.JSON){var s=new Uint8Array(e,f+a,n);this.content=o(s)}else if(i===h.BIN){var c=f+a;this.body=e.slice(c,c+n)}a+=n}if(null===this.content)throw new Error("GLTF2Loader: JSON content not found.")}function i(e,r,t){if(!e)return Promise.resolve();var a,n=[];if("[object Array]"===Object.prototype.toString.call(e)){a=[];for(var i=e.length,s=0;s<i;s++){var o=r.call(t||this,e[s],s);o&&(n.push(o),o instanceof Promise?o.then(function(e,r){a[e]=r}.bind(this,s)):a[s]=o)}}else{a={};for(var c in e)if(e.hasOwnProperty(c)){var o=r.call(t||this,e[c],c);o&&(n.push(o),o instanceof Promise?o.then(function(e,r){a[e]=r}.bind(this,c)):a[c]=o)}}return Promise.all(n).then(function(){return a})}function s(e,r){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:(r||"")+e}function o(e){for(var r="",t=0;t<e.length;t++)r+=String.fromCharCode(e[t]);return r}function c(e,r){var t={};for(var a in r.attributes){var n=r.attributes[a],i=r.parameters[n],s=i.type,o=i.semantic;t[a]={type:s,semantic:o}}var c=r.parameters,u=r.attributes,E={};for(var a in t){var n=u[a],d=c[n],o=d.semantic;o&&(E[a]=d)}for(var n in E){var i=E[n],o=i.semantic,l=new RegExp("\\b"+n+"\\b","g");switch(o){case"POSITION":e=e.replace(l,"position");break;case"NORMAL":e=e.replace(l,"normal");break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":e=e.replace(l,"uv");break;case"TEXCOORD_1":e=e.replace(l,"uv2");break;case"COLOR_0":case"COLOR0":case"COLOR":e=e.replace(l,"color");break;case"WEIGHTS_0":case"WEIGHT":e=e.replace(l,"skinWeight");break;case"JOINTS_0":case"JOINT":e=e.replace(l,"skinIndex")}}return e}function u(){return new THREE.MeshPhongMaterial({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:THREE.FrontSide})}function E(e){this.isDeferredShaderMaterial=!0,this.params=e}function d(e,t,a){this.json=e||{},this.extensions=t||{},this.options=a||{},this.cache=new r}e.prototype={constructor:e,load:function(e,r,t,a){var n=this,i=this.path&&"string"==typeof this.path?this.path:THREE.Loader.prototype.extractUrlBase(e),s=new THREE.FileLoader(n.manager);s.setResponseType("arraybuffer"),s.load(e,function(e){n.parse(e,r,i)},t,a)},setCrossOrigin:function(e){this.crossOrigin=e},setPath:function(e){this.path=e},parse:function(e,r,t){var i,s={};o(new Uint8Array(e,0,4))===p?(s[l.KHR_BINARY_GLTF]=new n(e),i=s[l.KHR_BINARY_GLTF].content):i=o(new Uint8Array(e));var c=JSON.parse(i);c.extensionsUsed&&c.extensionsUsed.indexOf(l.KHR_MATERIALS_COMMON)>=0&&(s[l.KHR_MATERIALS_COMMON]=new a(c)),new d(c,s,{path:t||this.path,crossOrigin:this.crossOrigin}).parse(function(e,t,a,n){r({scene:e,scenes:t,cameras:a,animations:n})})}},t.prototype.update=function(e,r){var t=this.boundUniforms;for(var a in t){var n=t[a];switch(n.semantic){case"MODELVIEW":var i=n.uniform.value;i.multiplyMatrices(r.matrixWorldInverse,n.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var s=n.uniform.value;this._m4.multiplyMatrices(r.matrixWorldInverse,n.sourceNode.matrixWorld),s.getNormalMatrix(this._m4);break;case"PROJECTION":var i=n.uniform.value;i.copy(r.projectionMatrix);break;case"JOINTMATRIX":for(var o=n.uniform.value,c=0;c<o.length;c++)o[c].getInverse(n.sourceNode.matrixWorld).multiply(n.targetNode.skeleton.bones[c].matrixWorld).multiply(n.targetNode.skeleton.boneInverses[c]).multiply(n.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+n.semantic)}}};var l={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common"},p="glTF",f=12,h={JSON:1313821514,BIN:5130562},m={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},v={5126:Number,35675:THREE.Matrix3,35676:THREE.Matrix4,35664:THREE.Vector2,35665:THREE.Vector3,35666:THREE.Vector4,35678:THREE.Texture},T={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},R={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},H={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},A={6406:THREE.AlphaFormat,6407:THREE.RGBFormat,6408:THREE.RGBAFormat,6409:THREE.LuminanceFormat,6410:THREE.LuminanceAlphaFormat},b={5121:THREE.UnsignedByteType,32819:THREE.UnsignedShort4444Type,32820:THREE.UnsignedShort5551Type,33635:THREE.UnsignedShort565Type},w={1028:THREE.BackSide,1029:THREE.FrontSide},y={512:THREE.NeverDepth,513:THREE.LessDepth,514:THREE.EqualDepth,515:THREE.LessEqualDepth,516:THREE.GreaterEqualDepth,517:THREE.NotEqualDepth,518:THREE.GreaterEqualDepth,519:THREE.AlwaysDepth},O={32774:THREE.AddEquation,32778:THREE.SubtractEquation,32779:THREE.ReverseSubtractEquation},L={0:THREE.ZeroFactor,1:THREE.OneFactor,768:THREE.SrcColorFactor,769:THREE.OneMinusSrcColorFactor,770:THREE.SrcAlphaFactor,771:THREE.OneMinusSrcAlphaFactor,772:THREE.DstAlphaFactor,773:THREE.OneMinusDstAlphaFactor,774:THREE.DstColorFactor,775:THREE.OneMinusDstColorFactor,776:THREE.SrcAlphaSaturateFactor},M={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},g={scale:"scale",translation:"position",rotation:"quaternion"},S={LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete},_={2884:"CULL_FACE",2929:"DEPTH_TEST",3042:"BLEND",3089:"SCISSOR_TEST",32823:"POLYGON_OFFSET_FILL",32926:"SAMPLE_ALPHA_TO_COVERAGE"};return E.prototype.create=function(){var e=THREE.UniformsUtils.clone(this.params.uniforms);for(var r in this.params.uniforms){var t=this.params.uniforms[r];t.value instanceof THREE.Texture&&(e[r].value=t.value,e[r].value.needsUpdate=!0),e[r].semantic=t.semantic,e[r].node=t.node}return this.params.uniforms=e,new THREE.RawShaderMaterial(this.params)},d.prototype._withDependencies=function(e){for(var r={},t=0;t<e.length;t++){var a=e[t],n="load"+a.charAt(0).toUpperCase()+a.slice(1),s=this.cache.get(a);if(void 0!==s)r[a]=s;else if(this[n]){var o=this[n]();this.cache.add(a,o),r[a]=o}}return i(r,function(e){return e})},d.prototype.parse=function(e){var r=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then(function(t){var a=[];for(var n in t.scenes)a.push(t.scenes[n]);var i=void 0!==r.scene?t.scenes[r.scene]:a[0],s=[];for(var n in t.cameras){var o=t.cameras[n];s.push(o)}var c=[];for(var n in t.animations)c.push(t.animations[n]);e(i,a,s,c)})},d.prototype.loadShaders=function(){var e=this.json,r=this.options;return this._withDependencies(["bufferViews"]).then(function(t){return i(e.shaders,function(e){if(void 0!==e.bufferView){var a=t.bufferViews[e.bufferView];return o(new Uint8Array(a))}return new Promise(function(t){var a=new THREE.FileLoader;a.setResponseType("text"),a.load(s(e.uri,r.path),function(e){t(e)})})})})},d.prototype.loadBuffers=function(){var e=this.json,r=this.extensions,t=this.options;return i(e.buffers,function(e,a){if("arraybuffer"===e.type||void 0===e.type)return void 0===e.uri&&0===a?r[l.KHR_BINARY_GLTF].body:new Promise(function(r){var a=new THREE.FileLoader;a.setResponseType("arraybuffer"),a.load(s(e.uri,t.path),function(e){r(e)})});console.warn("THREE.GLTF2Loader: "+e.type+" buffer type is not supported")})},d.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then(function(r){return i(e.bufferViews,function(e){var t=r.buffers[e.buffer],a=void 0!==e.byteLength?e.byteLength:0;return void 0==e.byteOffset&&(e.byteOffset=0),t.slice(e.byteOffset,e.byteOffset+a)})})},d.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then(function(r){return i(e.accessors,function(e){var t,a=r.bufferViews[e.bufferView],n=M[e.type],i=T[e.componentType],s=i.BYTES_PER_ELEMENT,o=s*n;if(e.byteStride&&e.byteStride!==o){t=new i(a);var c=new THREE.InterleavedBuffer(t,e.byteStride/s);return new THREE.InterleavedBufferAttribute(c,n,e.byteOffset/s)}return t=new i(a,e.byteOffset,e.count*n),new THREE.BufferAttribute(t,n)})})},d.prototype.loadTextures=function(){var e=this.json,r=this.options;return this._withDependencies(["bufferViews"]).then(function(t){return i(e.textures,function(a){if(void 0!==a.source)return new Promise(function(n){var i,o=e.images[a.source],c=o.uri;if(void 0!==o.bufferView){var u=t.bufferViews[o.bufferView],E=new Blob([u],{type:o.mimeType});i=window.URL||window.webkitURL,c=i.createObjectURL(E)}var d=THREE.Loader.Handlers.get(c);null===d&&(d=new THREE.TextureLoader),d.setCrossOrigin(r.crossOrigin),d.load(s(c,r.path),function(r){if(void 0!==i&&i.revokeObjectURL(c),r.flipY=!1,void 0!==a.name&&(r.name=a.name),r.format=void 0!==a.format?A[a.format]:THREE.RGBAFormat,
void 0!==a.internalFormat&&r.format!==A[a.internalFormat]&&console.warn("THREE.GLTF2Loader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),r.type=void 0!==a.type?b[a.type]:THREE.UnsignedByteType,void 0!==a.sampler){var t=e.samplers[a.sampler];r.magFilter=R[t.magFilter]||THREE.LinearFilter,r.minFilter=R[t.minFilter]||THREE.NearestMipMapLinearFilter,r.wrapS=H[t.wrapS]||THREE.RepeatWrapping,r.wrapT=H[t.wrapT]||THREE.RepeatWrapping}n(r)},void 0,function(){n()})})})})},d.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then(function(r){return i(e.materials,function(t){var a,n,i={},s={};if(t.extensions&&t.extensions[l.KHR_MATERIALS_COMMON]&&(n=t.extensions[l.KHR_MATERIALS_COMMON]),n){var o=["ambient","emission","transparent","transparency","doubleSided"];switch(n.technique){case"BLINN":case"PHONG":a=THREE.MeshPhongMaterial,o.push("diffuse","specular","shininess");break;case"LAMBERT":a=THREE.MeshLambertMaterial,o.push("diffuse");break;case"CONSTANT":default:a=THREE.MeshBasicMaterial}o.forEach(function(e){void 0!==n.values[e]&&(i[e]=n.values[e])}),(n.doubleSided||i.doubleSided)&&(s.side=THREE.DoubleSide),(n.transparent||i.transparent)&&(s.transparent=!0,s.opacity=void 0!==i.transparency?i.transparency:1)}else if(void 0===t.technique){if(void 0!==t.pbrMetallicRoughness){if(a=THREE.MeshStandardMaterial,void 0!==t.pbrMetallicRoughness){var u=t.pbrMetallicRoughness;if(s.color=new THREE.Color(1,1,1),s.opacity=1,Array.isArray(u.baseColorFactor)){var d=u.baseColorFactor;s.color.fromArray(d),s.opacity=d[3]}if(void 0!==u.baseColorTexture&&(s.map=r.textures[u.baseColorTexture.index]),(s.opacity<1||void 0!==s.map&&(s.map.format===THREE.AlphaFormat||s.map.format===THREE.RGBAFormat||s.map.format===THREE.LuminanceAlphaFormat))&&(s.transparent=!0),s.metalness=void 0!==u.metallicFactor?u.metallicFactor:1,s.roughness=void 0!==u.roughnessFactor?u.roughnessFactor:1,void 0!==u.metallicRoughnessTexture){var p=u.metallicRoughnessTexture.index;s.metalnessMap=r.textures[p],s.roughnessMap=r.textures[p]}}}else a=THREE.MeshPhongMaterial;void 0!==t.normalTexture&&(s.normalMap=r.textures[t.normalTexture.index]),void 0!==t.occlusionTexture&&(s.aoMap=r.textures[t.occlusionTexture.index]),void 0!==t.emissiveTexture&&(s.emissiveMap=r.textures[t.emissiveTexture.index]),s.emissive=new THREE.Color(0,0,0),void 0!==t.emissiveFactor&&s.emissive.fromArray(t.emissiveFactor),Object.assign(i,t.values)}else{a=E;var f=e.techniques[t.technique];s.uniforms={};var h=e.programs[f.program];if(h){s.fragmentShader=r.shaders[h.fragmentShader],s.fragmentShader||(console.warn("ERROR: Missing fragment shader definition:",h.fragmentShader),a=THREE.MeshPhongMaterial);var T=r.shaders[h.vertexShader];T||(console.warn("ERROR: Missing vertex shader definition:",h.vertexShader),a=THREE.MeshPhongMaterial),s.vertexShader=c(T,f);var R=f.uniforms;for(var H in R){var A=R[H],b=f.parameters[A],M=b.type;if(!v[M])throw new Error("Unknown shader uniform param type: "+M);var g,S=b.count;void 0!==t.values&&(g=t.values[A]);var x=new v[M],F=b.semantic,N=b.node;switch(M){case m.FLOAT:x=b.value,"transparency"==A&&(s.transparent=!0),void 0!==g&&(x=g);break;case m.FLOAT_VEC2:case m.FLOAT_VEC3:case m.FLOAT_VEC4:case m.FLOAT_MAT3:b&&b.value&&x.fromArray(b.value),g&&x.fromArray(g);break;case m.FLOAT_MAT2:console.warn("FLOAT_MAT2 is not a supported uniform type");break;case m.FLOAT_MAT4:if(S){x=new Array(S);for(var C=0;C<S;C++)x[C]=new v[M];if(b&&b.value){var D=b.value;x.fromArray(D)}g&&x.fromArray(g)}else{if(b&&b.value){var I=b.value;x.fromArray(I)}g&&x.fromArray(g)}break;case m.SAMPLER_2D:x=void 0!==g?r.textures[g.index]:void 0!==b.value?r.textures[b.value]:null}s.uniforms[H]={value:x,semantic:F,node:N}}for(var k=f.states||{},B=k.enable||[],U=k.functions||{},G=!1,P=!1,V=!1,j=0,K=B.length;j<K;j++){var q=B[j];switch(_[q]){case"CULL_FACE":G=!0;break;case"DEPTH_TEST":P=!0;break;case"BLEND":V=!0;break;case"SCISSOR_TEST":case"POLYGON_OFFSET_FILL":case"SAMPLE_ALPHA_TO_COVERAGE":break;default:throw new Error("Unknown technique.states.enable: "+q)}}s.side=G?void 0!==U.cullFace?w[U.cullFace]:THREE.FrontSide:THREE.DoubleSide,s.depthTest=P,s.depthFunc=void 0!==U.depthFunc?y[U.depthFunc]:THREE.LessDepth,s.depthWrite=void 0===U.depthMask||U.depthMask[0],s.blending=V?THREE.CustomBlending:THREE.NoBlending,s.transparent=V;var W=U.blendEquationSeparate;void 0!==W?(s.blendEquation=O[W[0]],s.blendEquationAlpha=O[W[1]]):(s.blendEquation=THREE.AddEquation,s.blendEquationAlpha=THREE.AddEquation);var Y=U.blendFuncSeparate;void 0!==Y?(s.blendSrc=L[Y[0]],s.blendDst=L[Y[1]],s.blendSrcAlpha=L[Y[2]],s.blendDstAlpha=L[Y[3]]):(s.blendSrc=THREE.OneFactor,s.blendDst=THREE.ZeroFactor,s.blendSrcAlpha=THREE.OneFactor,s.blendDstAlpha=THREE.ZeroFactor)}}t.extensions&&t.extensions.KHR_techniques_webgl&&void 0!=t.extensions.KHR_techniques_webgl.values.u_diffuse.index&&(s.map=r.textures[t.extensions.KHR_techniques_webgl.values.u_diffuse.index]),Array.isArray(i.diffuse)?s.color=(new THREE.Color).fromArray(i.diffuse):"string"==typeof i.diffuse&&(s.map=r.textures[i.diffuse]),delete s.diffuse,"string"==typeof i.reflective&&(s.envMap=r.textures[i.reflective]),"string"==typeof i.bump&&(s.bumpMap=r.textures[i.bump]),Array.isArray(i.emission)?a===THREE.MeshBasicMaterial?s.color=(new THREE.Color).fromArray(i.emission):s.emissive=(new THREE.Color).fromArray(i.emission):"string"==typeof i.emission&&(a===THREE.MeshBasicMaterial?s.map=r.textures[i.emission]:s.emissiveMap=r.textures[i.emission]),Array.isArray(i.specular)?s.specular=(new THREE.Color).fromArray(i.specular):"string"==typeof i.specular&&(s.specularMap=r.textures[i.specular]),void 0!==i.shininess&&(s.shininess=i.shininess);var X=new a(s);return void 0!==t.name&&(X.name=t.name),X})})},d.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then(function(r){return i(e.meshes,function(e){var t=new THREE.Group;void 0!==e.name&&(t.name=e.name),e.extras&&(t.userData=e.extras);var a=e.primitives||[];for(var n in a){var i,s,o=a[n],c=void 0!==o.material?r.materials[o.material]:u();if(o.mode===m.TRIANGLES||void 0===o.mode){i=new THREE.BufferGeometry;var E=o.attributes;for(var d in E){var l=E[d];if(void 0===l)return;var p=r.accessors[l];switch(d){case"POSITION":i.addAttribute("position",p);break;case"NORMAL":i.addAttribute("normal",p);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":i.addAttribute("uv",p);break;case"TEXCOORD_1":i.addAttribute("uv2",p);break;case"COLOR_0":case"COLOR0":case"COLOR":i.addAttribute("color",p);break;case"WEIGHTS_0":case"WEIGHT":i.addAttribute("skinWeight",p);break;case"JOINTS_0":case"JOINT":i.addAttribute("skinIndex",p)}}void 0!==o.indices&&i.setIndex(r.accessors[o.indices]),s=new THREE.Mesh(i,c),s.castShadow=!0}else{if(o.mode!==m.LINES)throw new Error("Only triangular and line primitives are supported");i=new THREE.BufferGeometry;var E=o.attributes;for(var d in E){var l=E[d];if(!l)return;var p=r.accessors[l];switch(d){case"POSITION":i.addAttribute("position",p);break;case"COLOR_0":case"COLOR0":case"COLOR":i.addAttribute("color",p)}}void 0!==o.indices?(i.setIndex(r.accessors[o.indices]),s=new THREE.LineSegments(i,c)):s=new THREE.Line(i,c)}void 0!==i.attributes.color&&(c.vertexColors=THREE.VertexColors,c.needsUpdate=!0),s.name="0"===n?t.name:t.name+n,o.extras&&(s.userData=o.extras),t.add(s)}return t})})},d.prototype.loadCameras=function(){return i(this.json.cameras,function(e){if("perspective"==e.type&&e.perspective){var r=e.perspective.yfov,t=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,a=r*t,n=new THREE.PerspectiveCamera(THREE.Math.radToDeg(a),t,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(n.name=e.name),e.extras&&(n.userData=e.extras),n}if("orthographic"==e.type&&e.orthographic){var n=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar);return void 0!==e.name&&(n.name=e.name),e.extras&&(n.userData=e.extras),n}})},d.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then(function(r){return i(e.skins,function(e){var t=new THREE.Matrix4;return void 0!==e.bindShapeMatrix&&t.fromArray(e.bindShapeMatrix),{bindShapeMatrix:t,jointNames:e.jointNames,inverseBindMatrices:r.accessors[e.inverseBindMatrices]}})})},d.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then(function(r){return i(e.animations,function(e,t){var a=[];for(var n in e.channels){var i=e.channels[n],s=e.samplers[i.sampler];if(s){var o=i.target,c=o.node||o.id,u=void 0!==e.parameters?e.parameters[s.input]:s.input,E=void 0!==e.parameters?e.parameters[s.output]:s.output,d=r.accessors[u],l=r.accessors[E],p=r.nodes[c];if(p){p.updateMatrix(),p.matrixAutoUpdate=!0;var f=g[o.path]===g.rotation?THREE.QuaternionKeyframeTrack:THREE.VectorKeyframeTrack,h=p.name?p.name:p.uuid,m=void 0!==s.interpolation?S[s.interpolation]:THREE.InterpolateLinear;a.push(new f(h+"."+g[o.path],THREE.AnimationUtils.arraySlice(d.array,0),THREE.AnimationUtils.arraySlice(l.array,0),m))}}}var c=void 0!==e.name?e.name:"animation_"+t;return new THREE.AnimationClip(c,void 0,a)})})},d.prototype.loadNodes=function(){var e=this.json,r=this.extensions,t=this;return i(e.nodes,function(e){var r,t=new THREE.Matrix4;return e.jointName?(r=new THREE.Bone,r.name=void 0!==e.name?e.name:e.jointName,r.jointName=e.jointName):(r=new THREE.Object3D,void 0!==e.name&&(r.name=e.name)),e.extras&&(r.userData=e.extras),void 0!==e.matrix?(t.fromArray(e.matrix),r.applyMatrix(t)):(void 0!==e.translation&&r.position.fromArray(e.translation),void 0!==e.rotation&&r.quaternion.fromArray(e.rotation),void 0!==e.scale&&r.scale.fromArray(e.scale)),r}).then(function(a){return t._withDependencies(["meshes","skins","cameras"]).then(function(t){return i(a,function(n,i){var s,o=e.nodes[i];if(void 0!==o.mesh?s=[o.mesh]:void 0!==o.meshes&&(console.warn("GLTF2Loader: Legacy glTF file detected. Nodes may have no more than 1 mesh."),s=o.meshes),void 0!==s)for(var c in s){var u=s[c],E=t.meshes[u];if(void 0!==E)for(var d in E.children){var p,f=E.children[d],h=f.material,m=f.geometry,v=f.userData,T=f.name;switch(h.isDeferredShaderMaterial?h=p=h.create():p=h,f.type){case"LineSegments":f=new THREE.LineSegments(m,p);break;case"LineLoop":f=new THREE.LineLoop(m,p);break;case"Line":f=new THREE.Line(m,p);break;default:f=new THREE.Mesh(m,p)}f.castShadow=!0,f.userData=v,f.name=T;var R;if(void 0!==o.skin&&(R=t.skins[o.skin]),R){var H=m,p=h;p.skinning=!0,f=new THREE.SkinnedMesh(H,p,!1),f.castShadow=!0,f.userData=v,f.name=T;for(var A=[],b=[],w=0,y=R.jointNames.length;w<y;w++){var O=R.jointNames[w],L=function(e){for(var r=Object.keys(a),t=0,n=r.length;t<n;t++){var i=a[r[t]];if(i.jointName===e)return i}return null}(O);if(L){A.push(L);var M=R.inverseBindMatrices.array,g=(new THREE.Matrix4).fromArray(M,16*w);b.push(g)}else console.warn("WARNING: joint: '"+O+"' could not be found")}f.bind(new THREE.Skeleton(A,b,!1),R.bindShapeMatrix);!function r(t,n,i){var s=t[i];if(void 0!==s)for(var o=0,c=s.length;o<c;o++){var u=s[o],E=a[u],d=e.nodes[u];void 0!==E&&!0===E.isBone&&void 0!==d&&(n.add(E),r(d,E,"children"))}}(o,f,"skeletons")}n.add(f)}else console.warn("GLTF2Loader: Couldn't find node \""+u+'".')}if(void 0!==o.camera){var S=t.cameras[o.camera];n.add(S)}if(o.extensions&&o.extensions[l.KHR_MATERIALS_COMMON]&&o.extensions[l.KHR_MATERIALS_COMMON].light){var _=r[l.KHR_MATERIALS_COMMON].lights,x=_[o.extensions[l.KHR_MATERIALS_COMMON].light];n.add(x)}return n})})})},d.prototype.loadScenes=function(){function e(t,a,n){var i=n[t];a.add(i);var s=r.nodes[t];if(s.children)for(var o=s.children,c=0,u=o.length;c<u;c++){var E=o[c];e(E,i,n)}}var r=this.json;return this._withDependencies(["nodes"]).then(function(a){return i(r.scenes,function(r){var n=new THREE.Scene;void 0!==r.name&&(n.name=r.name),r.extras&&(n.userData=r.extras);for(var i=r.nodes||[],s=0,o=i.length;s<o;s++){e(i[s],n,a.nodes)}return n.traverse(function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new t(e,a.nodes),e.onBeforeRender=function(e,r,t){this.gltfShader.update(r,t)})}),n})})},e}();